{% extends 'base.html' %}

{% block title %}Resultados e Exploração - {{ prediction.name }} - Mirach{% endblock %}

{% block extra_css %}
<style>
.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.metric-label {
    font-size: 0.9rem;
}

/* Chart tooltip styles */
.chart-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    opacity: 0;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    transition: opacity 0.2s ease;
}

.chart-tooltip strong {
    color: #fff;
    font-weight: 600;
}

.table-responsive {
    max-height: 400px;
    overflow-y: auto;
}

.loading {
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}


/* FORÇAR VISIBILIDADE DAS ABAS - SELETORES ESPECÍFICOS */
#data-tabs {
    border-bottom: 3px solid #dee2e6 !important;
    margin-bottom: 1rem !important;
    background: #f8f9fa !important;
    padding: 0.5rem !important;
    border-radius: 0.5rem 0.5rem 0 0 !important;
    display: flex !important;
    list-style: none !important;
}

#data-tabs .nav-item {
    margin-right: 0.5rem !important;
}

#data-tabs .nav-link {
    border: 2px solid #dee2e6 !important;
    border-bottom: none !important;
    border-radius: 0.5rem 0.5rem 0 0 !important;
    color: #495057 !important;
    font-weight: 600 !important;
    padding: 0.75rem 1.5rem !important;
    background: #e9ecef !important;
    text-decoration: none !important;
    display: inline-block !important;
    min-width: 120px !important;
    text-align: center !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
}

#data-tabs .nav-link:hover {
    border-color: #adb5bd !important;
    background: #dee2e6 !important;
    color: #212529 !important;
    transform: translateY(-2px) !important;
}

#data-tabs .nav-link.active {
    color: #0d6efd !important;
    background-color: #fff !important;
    border-color: #0d6efd #0d6efd #fff !important;
    border-bottom: 3px solid #0d6efd !important;
    font-weight: 700 !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

/* FORÇAR VISIBILIDADE DO BOTÃO VOLTAR - SELETORES ESPECÍFICOS */
a[href*="/predictions/"] {
    background-color: #ffffff !important;
    border: 3px solid #0d6efd !important;
    color: #0d6efd !important;
    font-weight: 700 !important;
    padding: 0.75rem 1.5rem !important;
    border-radius: 0.5rem !important;
    text-decoration: none !important;
    display: inline-block !important;
    min-width: 120px !important;
    text-align: center !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
    transition: all 0.3s ease !important;
}

a[href*="/predictions/"]:hover {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: #ffffff !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
    text-decoration: none !important;
}

/* Garantir contraste no header */
.card-header.bg-primary {
    background-color: #0d6efd !important;
    padding: 1.5rem !important;
}

.card-header.bg-primary a[href*="/predictions/"] {
    background-color: #ffffff !important;
    border: 3px solid #ffffff !important;
    color: #0d6efd !important;
    font-weight: 700 !important;
    padding: 0.75rem 1.5rem !important;
    border-radius: 0.5rem !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
}

.card-header.bg-primary a[href*="/predictions/"]:hover {
    background-color: #f8f9fa !important;
    border-color: #f8f9fa !important;
    color: #0d6efd !important;
    transform: translateY(-2px) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1">
                                <i class="fas fa-chart-line me-2"></i>Resultados e Exploração Interativa
                            </h4>
                            <p class="mb-0 opacity-75">
                                <strong>Previsão:</strong> {{ prediction.name }} | 
                                <strong>Modelo:</strong> {{ prediction.prediction_model.name }} |
                                <strong>Status:</strong> 
                                <span class="badge bg-light text-dark">{{ prediction.get_status_display }}</span>
                            </p>
                        </div>
                        <div class="btn-group">
                            <a href="{% url 'predictions:detail' prediction.pk %}" class="btn btn-light" style="background-color: #ffffff !important; border: 3px solid #0d6efd !important; color: #0d6efd !important; font-weight: 700 !important; padding: 0.75rem 1.5rem !important; border-radius: 0.5rem !important; text-decoration: none !important; display: inline-block !important; min-width: 120px !important; text-align: center !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                            <a href="{% url 'predictions:list' %}" class="btn btn-light" style="background-color: #ffffff !important; border: 3px solid #0d6efd !important; color: #0d6efd !important; font-weight: 700 !important; padding: 0.75rem 1.5rem !important; border-radius: 0.5rem !important; text-decoration: none !important; display: inline-block !important; min-width: 120px !important; text-align: center !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;">
                                <i class="fas fa-list"></i> Ver Todas
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Check -->
    {% if prediction.status != 'completed' %}
        <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle me-2"></i>
            Esta previsão ainda não foi concluída. Status atual: <strong>{{ prediction.get_status_display }}</strong>.
            <a href="{% url 'predictions:detail' prediction.pk %}" class="btn btn-sm btn-primary ms-2">
                <i class="fas fa-play"></i> Executar Previsão
            </a>
        </div>
    {% endif %}

    <!-- Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body">
                    <div class="metric-value text-danger" id="rmse-value">-</div>
                    <div class="metric-label text-muted">RMSE</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body">
                    <div class="metric-value text-warning" id="mae-value">-</div>
                    <div class="metric-label text-muted">MAE</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body">
                    <div class="metric-value text-info" id="mape-value">-</div>
                    <div class="metric-label text-muted">MAPE</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body">
                    <div class="metric-value text-success" id="r2-value">-</div>
                    <div class="metric-label text-muted">R²</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Controles e Filtros</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="chart-type" class="form-label">Tipo de Gráfico</label>
                                <select id="chart-type" class="form-select">
                                    <option value="line">Linha</option>
                                    <option value="area">Área</option>
                                    <option value="scatter">Scatter</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="forecast-horizon" class="form-label">Períodos de Previsão</label>
                                <input type="range" id="forecast-horizon" class="form-range" min="1" max="30" value="10">
                                <div class="text-center mt-2">
                                    <span id="horizon-value" class="badge bg-primary">10</span> períodos
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="show-confidence" class="form-label">Intervalo de Confiança</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="show-confidence" checked>
                                    <label class="form-check-label" for="show-confidence">
                                        Mostrar Intervalo
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Visualização Principal</h5>
                </div>
                <div class="card-body">
                    <div id="main-chart" class="loading">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">Carregando gráfico...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Métricas de Performance</h5>
                </div>
                <div class="card-body">
                    <div id="metrics-chart" class="loading">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">Carregando métricas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>Importância das Features</h5>
                </div>
                <div class="card-body">
                    <div id="features-chart" class="loading">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">Carregando features...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    {% if prediction.status == 'completed' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Resultados da Previsão</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Data</th>
                                    <th class="text-end">Previsão</th>
                                    <th class="text-end">Valor Real</th>
                                    <th class="text-end">IC Inferior</th>
                                    <th class="text-end">IC Superior</th>
                                    <th class="text-end">Erro</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in prediction.results.all %}
                                <tr>
                                    <td>{{ result.timestamp|date:'Y-m-d H:i' }}</td>
                                    <td class="text-end">
                                        <strong>{{ result.predicted_value|floatformat:2 }}</strong>
                                    </td>
                                    <td class="text-end">
                                        {% if result.actual_value %}
                                            {{ result.actual_value|floatformat:2 }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if result.confidence_interval_lower %}
                                            {{ result.confidence_interval_lower|floatformat:2 }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if result.confidence_interval_upper %}
                                            {{ result.confidence_interval_upper|floatformat:2 }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if result.actual_value %}
                                            {% widthratio result.predicted_value result.actual_value 100 as error_percent %}
                                            <span class="{% if error_percent|add:0 > 110 %}text-danger{% elif error_percent|add:0 > 105 %}text-warning{% else %}text-success{% endif %}">
                                                {{ error_percent|floatformat:1 }}%
                                            </span>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>Nenhum resultado disponível
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Data Tables -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Análise Detalhada</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="data-tabs" role="tablist" style="border-bottom: 3px solid #dee2e6 !important; margin-bottom: 1rem !important; background: #f8f9fa !important; padding: 0.5rem !important; border-radius: 0.5rem 0.5rem 0 0 !important; display: flex !important; list-style: none !important;">
                        <li class="nav-item" role="presentation" style="margin-right: 0.5rem !important;">
                            <button class="nav-link active" id="historical-tab" data-bs-toggle="tab" data-bs-target="#historical" type="button" role="tab" style="border: 2px solid #0d6efd !important; border-bottom: none !important; border-radius: 0.5rem 0.5rem 0 0 !important; color: #0d6efd !important; font-weight: 700 !important; padding: 0.75rem 1.5rem !important; background: #fff !important; text-decoration: none !important; display: inline-block !important; min-width: 120px !important; text-align: center !important; cursor: pointer !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;">
                                <i class="fas fa-history me-1"></i>Dados Históricos
                            </button>
                        </li>
                        <li class="nav-item" role="presentation" style="margin-right: 0.5rem !important;">
                            <button class="nav-link" id="forecast-tab" data-bs-toggle="tab" data-bs-target="#forecast" type="button" role="tab" style="border: 2px solid #dee2e6 !important; border-bottom: none !important; border-radius: 0.5rem 0.5rem 0 0 !important; color: #495057 !important; font-weight: 600 !important; padding: 0.75rem 1.5rem !important; background: #e9ecef !important; text-decoration: none !important; display: inline-block !important; min-width: 120px !important; text-align: center !important; cursor: pointer !important;">
                                <i class="fas fa-crystal-ball me-1"></i>Previsões
                            </button>
                        </li>
                        <li class="nav-item" role="presentation" style="margin-right: 0.5rem !important;">
                            <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" style="border: 2px solid #dee2e6 !important; border-bottom: none !important; border-radius: 0.5rem 0.5rem 0 0 !important; color: #495057 !important; font-weight: 600 !important; padding: 0.75rem 1.5rem !important; background: #e9ecef !important; text-decoration: none !important; display: inline-block !important; min-width: 120px !important; text-align: center !important; cursor: pointer !important;">
                                <i class="fas fa-info-circle me-1"></i>Resumo
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="data-tabs-content">
                        <div class="tab-pane fade show active" id="historical" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="historical-table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Data</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Historical data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="forecast" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="forecast-table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Data</th>
                                            <th>Previsão</th>
                                            <th>Confiança Inferior</th>
                                            <th>Confiança Superior</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Forecast data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="summary" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-cogs me-2"></i>Informações do Modelo</h6>
                                            <ul class="list-unstyled mb-0">
                                                <li><strong>Algoritmo:</strong> <span id="model-algorithm">-</span></li>
                                                <li><strong>Features:</strong> <span id="model-features">-</span></li>
                                                <li><strong>Amostras:</strong> <span id="model-samples">-</span></li>
                                                <li><strong>Parâmetros:</strong> <span id="model-params">-</span></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-chart-line me-2"></i>Estatísticas dos Dados</h6>
                                            <ul class="list-unstyled mb-0">
                                                <li><strong>Período:</strong> <span id="data-period">-</span></li>
                                                <li><strong>Observações:</strong> <span id="data-observations">-</span></li>
                                                <li><strong>Média:</strong> <span id="data-mean">-</span></li>
                                                <li><strong>Desvio:</strong> <span id="data-std">-</span></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-download me-2"></i>Exportação de Dados</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">Baixe os dados em diferentes formatos para análise externa:</p>
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-file-csv me-2"></i>Exportação Rápida</h6>
                            <div class="d-grid gap-2">
                                <a href="{% url 'predictions:export_csv' prediction.pk %}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-csv"></i> CSV Completo
                                </a>
                                <a href="{% url 'predictions:export_json' prediction.pk %}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-code"></i> JSON Completo
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-chart-line me-2"></i>Exportação Personalizada</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-success" onclick="downloadData('historical', 'csv')">
                                    <i class="fas fa-history"></i> Histórico CSV
                                </button>
                                <button class="btn btn-outline-success" onclick="downloadData('forecast', 'csv')">
                                    <i class="fas fa-crystal-ball"></i> Previsões CSV
                                </button>
                                <button class="btn btn-outline-info" onclick="downloadData('chart', 'png')">
                                    <i class="fas fa-image"></i> Gráfico PNG
                                </button>
                                <button class="btn btn-outline-info" onclick="downloadData('all', 'json')">
                                    <i class="fas fa-database"></i> Dados Completos JSON
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<div id="prediction-data" style="display: none;">
    {{ prediction_data|safe }}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// Sistema de tabs completamente customizado - sem Bootstrap
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('#data-tabs .nav-link');
    const tabPanes = document.querySelectorAll('#data-tabs-content .tab-pane');
    
    // Função para atualizar estilos das abas
    function updateTabStyles() {
        tabs.forEach((tab) => {
            const isActive = tab.classList.contains('active');
            
            if (isActive) {
                // Estilo para aba ativa - usando setAttribute para forçar
                tab.setAttribute('style', 'border: 2px solid #0d6efd !important; border-bottom: none !important; border-radius: 0.5rem 0.5rem 0 0 !important; color: #0d6efd !important; font-weight: 700 !important; padding: 0.75rem 1.5rem !important; background: #fff !important; text-decoration: none !important; display: inline-block !important; min-width: 120px !important; text-align: center !important; cursor: pointer !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;');
            } else {
                // Estilo para abas inativas - usando setAttribute para forçar
                tab.setAttribute('style', 'border: 2px solid #dee2e6 !important; border-bottom: none !important; border-radius: 0.5rem 0.5rem 0 0 !important; color: #495057 !important; font-weight: 600 !important; padding: 0.75rem 1.5rem !important; background: #e9ecef !important; text-decoration: none !important; display: inline-block !important; min-width: 120px !important; text-align: center !important; cursor: pointer !important;');
            }
        });
    }
    
    // Função para mostrar tab específica
    function showTab(targetTabId) {
        // Remover active de todas as abas e panes
        tabs.forEach(tab => {
            tab.classList.remove('active');
            tab.setAttribute('aria-selected', 'false');
        });
        
        tabPanes.forEach(pane => {
            pane.classList.remove('show', 'active');
        });
        
        // Ativar aba e pane específicos
        const targetTab = document.querySelector(`#data-tabs button[data-bs-target="${targetTabId}"]`);
        const targetPane = document.querySelector(targetTabId);
        
        if (targetTab && targetPane) {
            targetTab.classList.add('active');
            targetTab.setAttribute('aria-selected', 'true');
            targetPane.classList.add('show', 'active');
        }
        
        // Atualizar estilos
        updateTabStyles();
    }
    
    // Adicionar event listeners customizados
    tabs.forEach((tab) => {
        tab.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const targetId = this.getAttribute('data-bs-target');
            if (targetId) {
                showTab(targetId);
            }
        });
    });
    
    // Atualizar estilos iniciais
    updateTabStyles();
});
</script>
<script>
// Simple D3-based exploration
class PredictionExplorer {
    constructor() {
        this.data = null;
        this.historicalData = [];
        this.forecastData = [];
        this.metrics = {};
        this.init();
    }

    async init() {
        await this.loadData();
        this.setupEventListeners();
        this.render();
    }

    async loadData() {
        try {
            const dataElement = document.getElementById('prediction-data');
            if (dataElement?.textContent) {
                this.data = JSON.parse(dataElement.textContent);
            } else {
                const response = await fetch(`{% url 'predictions:api_prediction_results' prediction.pk %}`);
                this.data = await response.json();
            }
            this.processData();
        } catch (error) {
            console.error('Error loading data:', error);
            this.showError('Erro ao carregar dados');
        }
    }

    processData() {
        if (!this.data) return;
        
        this.historicalData = (this.data.historical_data || []).map(item => ({
            date: new Date(item.timestamp),
            value: parseFloat(item.actual_value || item.value)
        }));
        
        this.forecastData = (this.data.results || []).map(item => ({
            date: new Date(item.timestamp),
            predicted: parseFloat(item.predicted_value),
            ci_lower: parseFloat(item.ci_lower || item.predicted_value * 0.9),
            ci_upper: parseFloat(item.ci_upper || item.predicted_value * 1.1)
        }));
        
        this.metrics = this.data.metrics || {};
    }

    render() {
        this.updateMetrics();
        this.createMainChart();
        this.createMetricsChart();
        this.createFeaturesChart();
        this.updateTables();
        this.updateSummary();
    }

    updateMetrics() {
        const elements = {
            'rmse-value': this.metrics.rmse?.toFixed(2) || '-',
            'mae-value': this.metrics.mae?.toFixed(2) || '-',
            'mape-value': this.metrics.mape ? `${this.metrics.mape.toFixed(2)}%` : '-',
            'r2-value': this.metrics.r2?.toFixed(3) || '-'
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        });
    }

    createMainChart() {
        const container = d3.select('#main-chart');
        container.selectAll('*').remove();
        
        if (this.historicalData.length === 0 && this.forecastData.length === 0) {
            container.html('<p class="text-muted">Nenhum dado disponível</p>');
            return;
        }

        const margin = {top: 20, right: 30, bottom: 40, left: 50};
        const width = 800 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = container.append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom);

        const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        // Create tooltip
        const tooltip = d3.select('body').append('div')
            .attr('class', 'chart-tooltip')
            .style('position', 'absolute')
            .style('background', 'rgba(0, 0, 0, 0.8)')
            .style('color', 'white')
            .style('padding', '8px 12px')
            .style('border-radius', '4px')
            .style('font-size', '12px')
            .style('pointer-events', 'none')
            .style('opacity', 0)
            .style('z-index', 1000);

        // Combine all data for scale calculation
        const allData = [...this.historicalData, ...this.forecastData];
        const allDates = allData.map(d => d.date);
        const allValues = allData.map(d => d.value || d.predicted);

        const xScale = d3.scaleTime()
            .domain(d3.extent(allDates))
            .range([0, width]);

        const yScale = d3.scaleLinear()
            .domain(d3.extent(allValues))
            .nice()
            .range([height, 0]);

        // Add axes
        g.append('g')
            .attr('transform', `translate(0,${height})`)
            .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat('%Y-%m-%d')));

        g.append('g')
            .call(d3.axisLeft(yScale));

        // Add labels
        g.append('text')
            .attr('transform', 'rotate(-90)')
            .attr('y', 0 - margin.left)
            .attr('x', 0 - (height / 2))
            .attr('dy', '1em')
            .style('text-anchor', 'middle')
            .text('Valor');

        g.append('text')
            .attr('transform', `translate(${width / 2}, ${height + margin.bottom - 5})`)
            .style('text-anchor', 'middle')
            .text('Data');

        // Line generator
        const line = d3.line()
            .x(d => xScale(d.date))
            .y(d => yScale(d.value || d.predicted))
            .curve(d3.curveMonotoneX);

        // Historical data
        if (this.historicalData.length > 0) {
            g.append('path')
                .datum(this.historicalData)
                .attr('fill', 'none')
                .attr('stroke', '#1f77b4')
                .attr('stroke-width', 2)
                .attr('d', line);

            g.selectAll('.historical-dots')
                .data(this.historicalData)
                .enter().append('circle')
                .attr('class', 'historical-dots')
                .attr('cx', d => xScale(d.date))
                .attr('cy', d => yScale(d.value))
                .attr('r', 3)
                .attr('fill', '#1f77b4')
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    tooltip.transition().duration(200).style('opacity', 1);
                    tooltip.html(`
                        <strong>Dados Históricos</strong><br/>
                        Data: ${d3.timeFormat('%Y-%m-%d')(d.date)}<br/>
                        Valor: ${d.value.toFixed(2)}
                    `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.transition().duration(200).style('opacity', 0);
                });
        }

        // Forecast data
        if (this.forecastData.length > 0) {
            const horizon = parseInt(document.getElementById('forecast-horizon')?.value || 10);
            const forecastSubset = this.forecastData.slice(0, horizon);

            g.append('path')
                .datum(forecastSubset)
                .attr('fill', 'none')
                .attr('stroke', '#ff7f0e')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5,5')
                .attr('d', line);

            g.selectAll('.forecast-dots')
                .data(forecastSubset)
                .enter().append('circle')
                .attr('class', 'forecast-dots')
                .attr('cx', d => xScale(d.date))
                .attr('cy', d => yScale(d.predicted))
                .attr('r', 3)
                .attr('fill', '#ff7f0e')
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    tooltip.transition().duration(200).style('opacity', 1);
                    tooltip.html(`
                        <strong>Previsão</strong><br/>
                        Data: ${d3.timeFormat('%Y-%m-%d')(d.date)}<br/>
                        Valor Previsto: ${d.predicted.toFixed(2)}
                    `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.transition().duration(200).style('opacity', 0);
                });
        }
    }

    createMetricsChart() {
        const container = d3.select('#metrics-chart');
        container.selectAll('*').remove();

        const validMetrics = Object.entries(this.metrics).filter(([key, value]) => 
            value !== null && value !== undefined && !isNaN(value)
        );

        if (validMetrics.length === 0) {
            container.html('<p class="text-muted">Nenhuma métrica disponível</p>');
            return;
        }

        const margin = {top: 20, right: 30, bottom: 40, left: 50};
        const width = 400 - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;

        const svg = container.append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom);

        const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        // Create tooltip for metrics
        const tooltip = d3.select('body').append('div')
            .attr('class', 'chart-tooltip')
            .style('position', 'absolute')
            .style('background', 'rgba(0, 0, 0, 0.8)')
            .style('color', 'white')
            .style('padding', '8px 12px')
            .style('border-radius', '4px')
            .style('font-size', '12px')
            .style('pointer-events', 'none')
            .style('opacity', 0)
            .style('z-index', 1000);

        const xScale = d3.scaleBand()
            .domain(validMetrics.map(([key]) => key.toUpperCase()))
            .range([0, width])
            .padding(0.1);

        const maxValue = d3.max(validMetrics, ([key, value]) => Math.abs(value));
        const yScale = d3.scaleLinear()
            .domain([0, maxValue])
            .nice()
            .range([height, 0]);

        const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b'];

        g.selectAll('.bar')
            .data(validMetrics)
            .enter().append('rect')
            .attr('class', 'bar')
            .attr('x', ([key]) => xScale(key.toUpperCase()))
            .attr('width', xScale.bandwidth())
            .attr('y', ([key, value]) => yScale(Math.abs(value)))
            .attr('height', ([key, value]) => Math.max(0, height - yScale(Math.abs(value))))
            .attr('fill', (d, i) => colors[i % colors.length])
            .style('cursor', 'pointer')
            .on('mouseover', function(event, d) {
                const [key, value] = d;
                tooltip.transition().duration(200).style('opacity', 1);
                tooltip.html(`
                    <strong>Métrica: ${key.toUpperCase()}</strong><br/>
                    Valor: ${value.toFixed(4)}
                `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
            })
            .on('mouseout', function() {
                tooltip.transition().duration(200).style('opacity', 0);
            });

        g.append('g')
            .attr('transform', `translate(0,${height})`)
            .call(d3.axisBottom(xScale));

        g.append('g')
            .call(d3.axisLeft(yScale));
    }

    createFeaturesChart() {
        const container = d3.select('#features-chart');
        container.selectAll('*').remove();

        const featureImportance = this.data?.model_parameters?.feature_importance || {};
        
        if (Object.keys(featureImportance).length === 0) {
            container.html('<p class="text-muted">Importância das features não disponível</p>');
            return;
        }

        const sortedFeatures = Object.entries(featureImportance)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 15);

        const margin = {top: 20, right: 30, bottom: 40, left: 150};
        const width = 500 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = container.append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom);

        const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        // Create tooltip for features
        const tooltip = d3.select('body').append('div')
            .attr('class', 'chart-tooltip')
            .style('position', 'absolute')
            .style('background', 'rgba(0, 0, 0, 0.8)')
            .style('color', 'white')
            .style('padding', '8px 12px')
            .style('border-radius', '4px')
            .style('font-size', '12px')
            .style('pointer-events', 'none')
            .style('opacity', 0)
            .style('z-index', 1000);

        const yScale = d3.scaleBand()
            .domain(sortedFeatures.map(([feature]) => feature))
            .range([0, height])
            .padding(0.1);

        const xScale = d3.scaleLinear()
            .domain([0, d3.max(sortedFeatures, ([feature, importance]) => importance)])
            .nice()
            .range([0, width]);

        g.selectAll('.bar')
            .data(sortedFeatures)
            .enter().append('rect')
            .attr('class', 'bar')
            .attr('y', ([feature]) => yScale(feature))
            .attr('height', yScale.bandwidth())
            .attr('x', 0)
            .attr('width', ([feature, importance]) => xScale(importance))
            .attr('fill', '#2ca02c')
            .style('cursor', 'pointer')
            .on('mouseover', function(event, d) {
                const [feature, importance] = d;
                tooltip.transition().duration(200).style('opacity', 1);
                tooltip.html(`
                    <strong>Feature: ${feature}</strong><br/>
                    Importância: ${importance.toFixed(4)}
                `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
            })
            .on('mouseout', function() {
                tooltip.transition().duration(200).style('opacity', 0);
            });

        g.append('g')
            .call(d3.axisLeft(yScale));

        g.append('g')
            .attr('transform', `translate(0,${height})`)
            .call(d3.axisBottom(xScale));
    }

    updateTables() {
        this.updateHistoricalTable();
        this.updateForecastTable();
    }

    updateHistoricalTable() {
        const tbody = document.querySelector('#historical-table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = this.historicalData.map(item => 
            `<tr><td>${item.date.toLocaleDateString()}</td><td>${item.value.toFixed(2)}</td></tr>`
        ).join('');
    }

    updateForecastTable() {
        const tbody = document.querySelector('#forecast-table tbody');
        if (!tbody) return;
        
        const horizon = parseInt(document.getElementById('forecast-horizon')?.value || 10);
        const forecastSubset = this.forecastData.slice(0, horizon);
        
        tbody.innerHTML = forecastSubset.map(item => 
            `<tr>
                <td>${item.date.toLocaleDateString()}</td>
                <td>${item.predicted.toFixed(2)}</td>
                <td>${item.ci_lower.toFixed(2)}</td>
                <td>${item.ci_upper.toFixed(2)}</td>
            </tr>`
        ).join('');
    }

    updateSummary() {
        const elements = {
            'model-algorithm': this.data?.model_algorithm || '-',
            'model-features': this.data?.model_parameters?.n_features || '-',
            'model-samples': this.data?.model_parameters?.n_samples || '-',
            'model-params': JSON.stringify(this.data?.model_parameters || {}, null, 2)
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        });

        if (this.historicalData.length > 0) {
            const dates = this.historicalData.map(d => d.date);
            const values = this.historicalData.map(d => d.value);
            const mean = values.reduce((a,b) => a+b, 0) / values.length;
            const variance = values.reduce((a,b) => a + Math.pow(b - mean, 2), 0) / values.length;
            const std = Math.sqrt(variance);

            document.getElementById('data-period').textContent = 
                `${dates[0].toLocaleDateString()} - ${dates[dates.length-1].toLocaleDateString()}`;
            document.getElementById('data-observations').textContent = this.historicalData.length;
            document.getElementById('data-mean').textContent = mean.toFixed(2);
            document.getElementById('data-std').textContent = std.toFixed(2);
        }
    }

    setupEventListeners() {
        const chartType = document.getElementById('chart-type');
        const horizon = document.getElementById('forecast-horizon');
        const confidence = document.getElementById('show-confidence');

        if (chartType) chartType.addEventListener('change', () => this.render());
        if (horizon) {
            horizon.addEventListener('input', (e) => {
                document.getElementById('horizon-value').textContent = e.target.value;
                this.render();
            });
        }
        if (confidence) confidence.addEventListener('change', () => this.render());
    }

    downloadData(type, format) {
        let data, filename;
        
        switch (type) {
            case 'historical':
                data = this.historicalData.map(item => ({
                    date: item.date.toISOString().split('T')[0],
                    value: item.value
                }));
                filename = `dados_historicos_${format}`;
                break;
            case 'forecast':
                const horizon = parseInt(document.getElementById('forecast-horizon')?.value || 10);
                data = this.forecastData.slice(0, horizon).map(item => ({
                    date: item.date.toISOString().split('T')[0],
                    predicted: item.predicted,
                    ci_lower: item.ci_lower,
                    ci_upper: item.ci_upper
                }));
                filename = `previsoes_${format}`;
                break;
            case 'chart':
                this.downloadChartAsPNG();
                return;
            case 'all':
                data = {
                    historical: this.historicalData,
                    forecast: this.forecastData,
                    metrics: this.metrics,
                    modelParameters: this.data?.model_parameters
                };
                filename = `dados_completos_${format}`;
                break;
        }
        
        if (format === 'csv' && Array.isArray(data)) {
            const csv = this.convertToCSV(data);
            this.downloadFile(csv, filename, 'text/csv');
        } else {
            this.downloadFile(JSON.stringify(data, null, 2), filename, 'application/json');
        }
    }

    downloadChartAsPNG() {
        const svg = d3.select('#main-chart svg');
        if (svg.empty()) {
            alert('Nenhum gráfico disponível para download');
            return;
        }

        // Get SVG data
        const svgData = new XMLSerializer().serializeToString(svg.node());
        
        // Create canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        // Set canvas size
        const svgRect = svg.node().getBoundingClientRect();
        canvas.width = svgRect.width;
        canvas.height = svgRect.height;
        
        // Convert SVG to PNG
        img.onload = () => {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            // Download
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'grafico_previsao.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        };
        
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
    }

    convertToCSV(data) {
        if (data.length === 0) return '';
        const headers = Object.keys(data[0]);
        return [
            headers.join(','),
            ...data.map(row => headers.map(header => row[header]).join(','))
        ].join('\n');
    }

    downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    showError(message) {
        ['main-chart', 'metrics-chart', 'features-chart'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.innerHTML = `<p class="text-danger">${message}</p>`;
        });
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    new PredictionExplorer();
});
</script>
{% endblock %}
